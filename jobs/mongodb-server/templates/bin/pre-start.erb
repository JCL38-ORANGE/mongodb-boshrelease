#!/bin/bash
#set -e
set -u 
#set -x

source `dirname $(readlink --canonicalize-existing $0)`/setenv

<%-
if p("mongodb-server.Db_Type") == "rs"
  DbTypeport = p("mongodb-server.rs_port") 
  _rsconfig = ''
  link('server').instances.each do |instance| 
    _rsconfig = "#{_rsconfig}#{instance.address}:#{DbTypeport},"
  end
  # remove last ,
  rsconfig = _rsconfig[0..-2]
  current_ip = spec.ip
end
if p("mongodb-server.Conf_UseSSL") == 0 -%>
export CMD="/var/vcap/jobs/${JOB_NAME}/bin/mongo.sh"
<%- else -%>
# Generate the certificates
/var/vcap/jobs/${JOB_NAME}/bin/generate_ssl_cert.sh
export CMD="/var/vcap/jobs/${JOB_NAME}/bin/mongo-ssl.sh"
<%- end -%>

get_actual_members()
{
  m_list=""
  for i in `${CMD} --host rs0/<%= current_ip %>  ${CMD_PARAM} --eval 'rs.status().members'| \
  grep name|tr -s [:space:]|tr -d '"'|cut -d ":" -f2`
  do
    m_list="$m_list $i"
  done
  echo $m_list
}

start_bs()
{
  # Stopping eventually running instance
  if [ -f $PIDFILE ]
    then
    [ `ps -p $(cat $PIDFILE)|wc -l` -gt 1 ] && kill_and_wait $PIDFILE
  fi

  pid_guard $PIDFILE ${JOB_NAME}

  # start mongod without auth
  su -m vcap -c "$MONGODB_BIN/mongod --config $MONGODB_CONF/mongod_bootstrap.conf --pidfilepath $PIDFILE"
}

sys_update()
{
  # creating needed directories
  for dir in $RUN_DIR $LOG_DIR $TMP_DIR $STORE_DIR $DATA_DIR $BACKUP_DIR
  do
    mkdir -p ${dir}
    chown vcap:vcap ${dir}
    chmod 775 ${dir}
  done

  # updating vcap limits
  if [ -f /etc/security/limits.conf ]
  then
    if [ `grep "$(cat $JOB_DIR/config/vcap_limits.conf)" /etc/security/limits.conf|wc -l` -eq 0 ]
    then 	
      cat $JOB_DIR/config/vcap_limits.conf >> /etc/security/limits.conf
    fi  
  # Allow limits apply without rebooting
    if [ -f /etc/pam.d/common-session ]
    then
      if [ `grep "^session required pam_limits.so" /etc/pam.d/common-session|wc -l` -eq 0 ]
      then	
        echo "# Allow limits apply without rebooting" >> /etc/pam.d/common-session
        echo "session required pam_limits.so" >> /etc/pam.d/common-session
      fi  
    fi
  fi

  # disabeling transparent_hugepage
  if [ -d /sys/kernel/mm/transparent_hugepage ]; then
        thp_path=/sys/kernel/mm/transparent_hugepage
  elif [ -d /sys/kernel/mm/redhat_transparent_hugepage ]; then
        thp_path=/sys/kernel/mm/redhat_transparent_hugepage
  else
        return 0
  fi

  echo 'never' > ${thp_path}/enabled
  echo 'never' > ${thp_path}/defrag
  unset thp_path
}

check_master()
{
  # looking for already created master node
  Master=""
  for Server in $(echo <%= rsconfig -%>|tr -s "," " ")
  do

    if [ "`${CMD} --host $Server \
      ${CMD_PARAM} --eval 'db.isMaster().ismaster' 2>/dev/null`" == "true" ]
    then
      Master=$Server
    else
      if [ "`${CMD} --host $Server -u '<%= p("mongodb-server.Db_RootAdminName") %>' \
        -p '<%= p("mongodb-server.Db_RootAdminPwd") %>' --authenticationDatabase admin \
      ${CMD_PARAM} --eval 'db.isMaster().ismaster' 2>/dev/null`" == "true" ]
      then
        Master=$Server
      fi
    fi
  done    
  echo $Master
}

remove_unwanted_nodes()
{
  export CMD_PARAM="${CMD_PARAM} \
  -u <%= p("mongodb-server.Db_RootAdminName") %> -p <%= p("mongodb-server.Db_RootAdminPwd") %> --authenticationDatabase admin"
  
  wanted_servers=$(echo <%= rsconfig -%>|tr -s "," " ")
  for defined_server in $( get_actual_members )
  do
    if [ `echo $wanted_servers| grep $defined_server|wc -l` -eq 0 ]
    then
      ${CMD} --host <%= p("mongodb-server.Conf_replSetName") %>/$Master \
  ${CMD_PARAM} --eval 'rs.remove("'$defined_server':<%= DbTypeport %>")'
    fi
  done
}

create_admin_users()
{
     # check if admin users have already been created
    CR=1
    while [ $CR -ne 0 ]
    do
      created=`${CMD} ${CMD_PARAM} --host <%= current_ip %> \
      --eval 'db.getUser("<%= p("mongodb-server.Db_UserAdminName") %>")' admin`
      CR=$?
      [ $CR -eq 0 -a "$created" == "null" ] && CR=1
      if [ $CR -eq 0 ]
      then
        created=`${CMD} ${CMD_PARAM} --host <%= current_ip %> \
        --eval 'db.getUser("<%= p("mongodb-server.Db_RootAdminName") %>")' admin`
        CR=$?
        [ $CR -eq 0 -a "$created" == "null" ] && CR=1
      fi
      # Create admin users if not already created
      if [ $CR -ne 0 ]
      then
         ${CMD} ${CMD_PARAM} --host <%= current_ip %> < /var/vcap/jobs/${JOB_NAME}/js/create_admin_user.js
      fi
    done
}

init_rs()
{
    CR=1
    while [ $CR -ne 0 ]
    do
      ${CMD} --host <%= current_ip %> \
      ${CMD_PARAM} < /var/vcap/jobs/${JOB_NAME}/js/initiate_rs.js
      CR=$?
    done
    # wait until rs is fully active
    # while [ `${CMD} --host <%= current_ip %> ${CMD_PARAM} --eval 'rs.status().ok'` -ne 1 -o \
    # $(${CMD} --host <%= current_ip %> ${CMD_PARAM} --eval 'rs.status().members'| \
    # grep "\"infoMessage\" : \"could not find member to sync from\""|wc -l) -gt 0 ]
    while [ `${CMD} --host <%= current_ip %> ${CMD_PARAM} --eval 'rs.status().ok'` -ne 1 ]
    do
      sleep 3
    done
}

#################" Main "###########################""
sys_update

export CMD_PARAM="--quiet"

Master=$( check_master )

if [ "$Master" == "" -o "$Master" == "<%= current_ip %>" ]
then
  [ "$Master" == "" ] && start_bs || remove_unwanted_nodes
  # check if rs is already initialized
  if [ "$(${CMD} --host <%= current_ip %> ${CMD_PARAM} \
    --eval 'rs.status().codeName' 2>/dev/null)" == "NotYetInitialized" ]
  then
    init_rs
    create_admin_users
 fi
else
  start_bs
  export CMD_PARAM="${CMD_PARAM} -u <%= p("mongodb-server.Db_RootAdminName") %> -p <%= p("mongodb-server.Db_RootAdminPwd") %> --authenticationDatabase admin"
  # check Master node if admin users have already been created
  admin_initialized=`${CMD} --host $Master ${CMD_PARAM} \
  --eval 'db.getUser("<%= p("mongodb-server.Db_UserAdminName") %>")' admin`
  CR=$?
  [ $CR -eq 0 -a "$admin_initialized" == "null" ] && CR=1
  if [ $CR -eq 0 ]
  then
    admin_initialized=`${CMD} --host $Master  ${CMD_PARAM} \
    --eval 'db.getUser("<%= p("mongodb-server.Db_RootAdminName") %>")' admin`
    CR=$?
    [ $CR -eq 0 -a "$admin_initialized" == "null" ] && CR=1
  fi

  if [ $CR -eq 0 ]
  then
    # restarting with auth
    kill_and_wait $PIDFILE
    pid_guard $PIDFILE ${JOB_NAME}
    su -m vcap -c "$MONGODB_BIN/mongod --config $MONGODB_CONF/mongod.conf --pidfilepath $PIDFILE"
  else
    exit 1
  fi

  # Adding current node to rs
  ${CMD} --host <%= p("mongodb-server.Conf_replSetName") %>/$Master \
  ${CMD_PARAM} --eval 'rs.add("<%= current_ip %>:<%= DbTypeport %>")'
  [ $? -ne 0 ] && exit 1
  # need to wait for complete add before restarting
  _timeout=30
  add_ok="false"
  while [ "$add_ok" == "false" ]
  do
    add_ok=`${CMD} --host <%= current_ip %>:<%= DbTypeport %> ${CMD_PARAM} \
   --eval 'rs.isMaster().secondary'`
    if [ "$add_ok" != "true" ]
    then
      sleep 2
      _timeout=$((_timeout-2))
      [ ${_timeout} -le 0 ] && echo "node <%= current_ip %>:<%= DbTypeport %> hasn\'t been added. Timeout reached" && exit 1
    fi
  done

fi

kill_and_wait $PIDFILE

exit 0
