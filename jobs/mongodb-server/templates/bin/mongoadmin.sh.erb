#!/bin/bash

source `dirname $(readlink --canonicalize-existing $0)`/setenv

<%- if p("mongodb-server.Conf_UseSSL") == 0 -%>
export MONGO_CMD="/var/vcap/jobs/${JOB_NAME}/bin/mongo.sh"
<%- else -%>
export MONGO_CMD="/var/vcap/jobs/${JOB_NAME}/bin/mongo-ssl.sh"
<%- end -%>
<%- if p("mongodb-server.Db_Type") == "rs"
     mongo_DbTypeport=p("mongodb-server.rs_port")
     _mongo_rsconfig = ''
     link('server').instances.each do |instance|
       _mongo_rsconfig = "#{_mongo_rsconfig}#{instance.address}:#{mongo_DbTypeport},"
   end
   # remove last ,
   mongo_rsconfig = _mongo_rsconfig[0..-2]
end -%>

export PARAM="$@"

pushd /var/vcap/packages/mongodb/bin >/dev/null
${MONGO_CMD} --host <%= p("mongodb-server.Conf_replSetName") %>/<%= mongo_rsconfig %> \
 -u <%= p("mongodb-server.Db_RootAdminName") %> -p <%= p("mongodb-server.Db_RootAdminPwd") %> --authenticationDatabase admin \
 $PARAM
popd >/dev/null
exit 0
