#!/bin/bash

source `dirname $(readlink --canonicalize-existing $0)`/setenv

<%- if p("mongodb-server.Conf_UseSSL") == 0 -%>
export CMD="/var/vcap/jobs/${JOB_NAME}/bin/mongo.sh"
<%- else -%>
export CMD="/var/vcap/jobs/${JOB_NAME}/bin/mongo-ssl.sh"
<%- end -%>
<%- if p("mongodb-server.Db_Type") == "rs" 
     DbTypeport=p("mongodb-server.rs_port") 
     _rsconfig = ''
     link('server').instances.each do |instance| 
       _rsconfig = "#{_rsconfig}#{instance.address}:#{DbTypeport}," 
   end
   # remove last ,
   rsconfig = _rsconfig[0..-2]
end -%>

export PARAM="$@"

pushd /var/vcap/packages/mongodb/bin >/dev/null
${CMD} --host <%= p("mongodb-server.Conf_replSetName") %>/<%= rsconfig %> \
 -u <%= p("mongodb-server.Db_RootAdminName") %> -p <%= p("mongodb-server.Db_RootAdminPwd") %> --authenticationDatabase admin \
 $PARAM
popd >/dev/null
exit 0
