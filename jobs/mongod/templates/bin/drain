#!/usr/bin/env bash
set -eu
export JOB_NAME='mongod'

# uncomment this line if you need log on failed drain
# exec 1>>/var/vcap/sys/log/${JOB_NAME}/drain.stdout.log 2>>/var/vcap/sys/log/${JOB_NAME}/drain.stderr.log

source `dirname $(readlink -f $0)`/setenv
source `dirname $(readlink -f $0)`/mdb-functions

export PIDFILE=$RUN_DIR/mongod.pid

if [ $(check_ssl) -eq 0 ]
then
  export MONGO_CMD="/var/vcap/jobs/${JOB_NAME}/bin/mongo.sh"
else
  export MONGO_CMD="/var/vcap/jobs/${JOB_NAME}/bin/mongo-ssl.sh"
fi

export MONGO_CMD_PARAM="--quiet"


if [ "$(get_node_role)" == "rs" ]
then
        # shutdown mongodb first to ensure to give master role to another node
        [ -f $PIDFILE ] && [ `ps -p $(cat $PIDFILE)|wc -l` -gt 0 ] && kill_and_wait $PIDFILE
#       /var/vcap/bosh/bin/monit stop all

    # Tell the master to remove current node from it's conf
    remove_secondary
fi

echo 0

exit 0